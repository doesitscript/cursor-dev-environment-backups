# ~/.config/workflows/Makefile.mcp-verify
# Enterprise MCP System Verification Makefile
# Comprehensive integrity checks for the Guardrails MCP server system

.PHONY: verify-claude-turn verify-system-integrity verify-config-files verify-environment verify-manifests verify-memory-keeper verify-cli-tools verify-backups verify-security verify-performance

# Main verification target
verify-claude-turn: verify-system-integrity verify-config-files verify-environment verify-manifests verify-memory-keeper verify-cli-tools verify-backups verify-security verify-performance
	@echo "== MCP TRUST LOOP INSTALL INTEGRITY VERIFICATION COMPLETE =="
	@echo "Status: ALL SYSTEMS VERIFIED"
	@echo "Timestamp: $$(date)"
	@echo "Version: 2.0.0"

# System Integrity Check
verify-system-integrity:
	@echo "== SYSTEM INTEGRITY VERIFICATION =="
	@echo "[Core Paths]"
	@echo " rules:        $$HOME/.config/workflows/cursorrules.d/20_mcp_trust_loop.rules"
	@echo " env:          $$HOME/.config/workflows/mcp.env"
	@echo " guard cfg:    $$HOME/.local/mcp-servers/guardrail/config.yaml"
	@echo " manifest dir: $$HOME/.manifests"
	@echo " mem data dir: $$HOME/mcp-data/memory-keeper"
	@echo " rule logs:    $$HOME/.mcp/rule-logs"
	@echo " audit log:    $$HOME/.mcp/audit.log"
	@echo

# Configuration Files Verification
verify-config-files:
	@echo "== CONFIGURATION FILES VERIFICATION =="
	@echo "[Files Exist Check]"
	@test -f "$$HOME/.config/workflows/cursorrules.d/20_mcp_trust_loop.rules" && echo " ✓  $$HOME/.config/workflows/cursorrules.d/20_mcp_trust_loop.rules" || echo " ✗  MISSING: $$HOME/.config/workflows/cursorrules.d/20_mcp_trust_loop.rules"
	@test -f "$$HOME/.config/workflows/mcp.env" && echo " ✓  $$HOME/.config/workflows/mcp.env" || echo " ✗  MISSING: $$HOME/.config/workflows/mcp.env"
	@test -f "$$HOME/.local/mcp-servers/guardrail/config.yaml" && echo " ✓  $$HOME/.local/mcp-servers/guardrail/config.yaml" || echo " ✗  MISSING: $$HOME/.local/mcp-servers/guardrail/config.yaml"
	@test -f "$$HOME/.cursor/mcp.json" && echo " ✓  $$HOME/.cursor/mcp.json" || echo " ✗  MISSING: $$HOME/.cursor/mcp.json"
	@echo

# Environment Verification
verify-environment:
	@echo "== ENVIRONMENT VERIFICATION =="
	@echo "[Environment Variables Preview]"
	@echo "MEMORY_KEEPER_AUTO_UPDATE: $$(grep -E '^export MEMORY_KEEPER_AUTO_UPDATE' "$$HOME/.config/workflows/mcp.env" 2>/dev/null | cut -d'=' -f2 || echo 'NOT SET')"
	@echo "DATA_DIR: $$(grep -E '^export DATA_DIR' "$$HOME/.config/workflows/mcp.env" 2>/dev/null | cut -d'=' -f2 || echo 'NOT SET')"
	@echo "MCP_DEFAULT_CHANNEL: $$(grep -E '^export MCP_DEFAULT_CHANNEL' "$$HOME/.config/workflows/mcp.env" 2>/dev/null | cut -d'=' -f2 || echo 'NOT SET')"
	@echo "MEMORY_KEEPER_CHANNEL: $$(grep -E '^export MEMORY_KEEPER_CHANNEL' "$$HOME/.config/workflows/mcp.env" 2>/dev/null | cut -d'=' -f2 || echo 'NOT SET')"
	@echo

# Manifests Verification
verify-manifests:
	@echo "== MANIFESTS VERIFICATION =="
	@echo "[Manifests Directory]"
	@test -d "$$HOME/.manifests" && echo " ✓  Directory exists: $$HOME/.manifests" || echo " ✗  Directory missing: $$HOME/.manifests"
	@echo "[Latest Manifest]"
	@ls -1t "$$HOME/.manifests"/mcp_setup_*.yaml 2>/dev/null | head -n1 || echo " No manifests found (expected for new installations)"
	@echo "[Manifest Count]"
	@ls -1 "$$HOME/.manifests"/mcp_setup_*.yaml 2>/dev/null | wc -l | xargs echo "Total manifests:"
	@echo

# Memory Keeper Verification
verify-memory-keeper:
	@echo "== MEMORY KEEPER VERIFICATION =="
	@echo "[Data Directory Contents]"
	@test -d "$$HOME/mcp-data/memory-keeper" && echo " ✓  Directory exists: $$HOME/mcp-data/memory-keeper" || echo " ✗  Directory missing: $$HOME/mcp-data/memory-keeper"
	@echo "[Database Files]"
	@ls -1 "$$HOME/mcp-data/memory-keeper"/*.db* 2>/dev/null | head -n 5 || echo " No database files found (expected until first use)"
	@echo "[Directory Size]"
	@du -sh "$$HOME/mcp-data/memory-keeper" 2>/dev/null || echo " Directory not accessible"
	@echo

# CLI Tools Verification
verify-cli-tools:
	@echo "== CLI TOOLS VERIFICATION =="
	@echo "[Memory Keeper CLI]"
	@echo " memory-keeper CLI: $$(command -v mcp-memory-keeper 2>/dev/null || echo 'not installed')"
	@echo "[Chat History Recorder CLI]"
	@echo " chat-recorder CLI: $$(command -v mcp-chat-history-recorder 2>/dev/null || echo 'not installed')"
	@echo "[Guardrails CLI]"
	@echo " guardrails CLI: $$(command -v mcp-guardrail 2>/dev/null || echo 'not installed')"
	@echo

# Backups Verification
verify-backups:
	@echo "== BACKUPS VERIFICATION =="
	@echo "[Backup Directory]"
	@test -d "$$HOME/.cursor/mcp-backups" && echo " ✓  Backup directory exists" || echo " ✗  Backup directory missing"
	@echo "[Recent Backups]"
	@ls -1t "$$HOME/.cursor"/mcp*.json 2>/dev/null | head -n 3 || echo " No backup files found"
	@echo "[Backup Count]"
	@ls -1 "$$HOME/.cursor"/mcp*.json 2>/dev/null | wc -l | xargs echo "Total backups:"
	@echo

# Security Verification
verify-security:
	@echo "== SECURITY VERIFICATION =="
	@echo "[Rule Files]"
	@test -d "$$HOME/.mcp/rules" && echo " ✓  Rules directory exists" || echo " ✗  Rules directory missing"
	@echo "[Rule Files Count]"
	@ls -1 "$$HOME/.mcp/rules"/*.json 2>/dev/null | wc -l | xargs echo "Rule files:"
	@echo "[Audit Logging]"
	@test -f "$$HOME/.mcp/audit.log" && echo " ✓  Audit log exists" || echo " ✗  Audit log missing"
	@echo

# Performance Verification
verify-performance:
	@echo "== PERFORMANCE VERIFICATION =="
	@echo "[Cache Directory]"
	@test -d "$$HOME/.mcp/cache" && echo " ✓  Cache directory exists" || echo " ✗  Cache directory missing"
	@echo "[Log Directory]"
	@test -d "$$HOME/.mcp/rule-logs" && echo " ✓  Log directory exists" || echo " ✗  Log directory missing"
	@echo "[System Resources]"
	@echo " Available disk space: $$(df -h "$$HOME" | tail -1 | awk '{print $$4}')"
	@echo

# Rules Content Verification
verify-rules-content:
	@echo "== RULES CONTENT VERIFICATION =="
	@echo "[Trust Loop Rules Preview]"
	@sed -n '1,15p' "$$HOME/.config/workflows/cursorrules.d/20_mcp_trust_loop.rules" 2>/dev/null || echo " Rules file not accessible"
	@echo
	@echo "[Environment Preview]"
	@grep -E 'MEMORY_KEEPER_AUTO_UPDATE|DATA_DIR|MCP_DEFAULT_CHANNEL|MEMORY_KEEPER_CHANNEL' "$$HOME/.config/workflows/mcp.env" 2>/dev/null || echo " Environment file not accessible"
	@echo

# Quick Status Check
status:
	@echo "== QUICK STATUS CHECK =="
	@echo "System Status: $$(if [ -f "$$HOME/.config/workflows/cursorrules.d/20_mcp_trust_loop.rules" ] && [ -f "$$HOME/.config/workflows/mcp.env" ]; then echo "ACTIVE"; else echo "INCOMPLETE"; fi)"
	@echo "Last Updated: $$(date)"
	@echo "Version: 2.0.0"
	@echo "Configuration: Enterprise Grade"
	@echo "Status: Ready for Production Use"